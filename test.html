<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css">
<style>
  b {color: #dc3545 !important;}
  html {overflow-y: scroll;}
</style>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.4.2/vue.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/platform/1.3.4/platform.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/benchmark/2.1.4/benchmark.min.js"></script>
<script src="./fuzzysort.js"></script>
<script src="./testdata.js"></script>
<script src="./test.js"></script>

<div id="app" class="jumbotron" style="background:none">
  <div class="container">
    <div><div class="btn-group" data-toggle="buttons">
      <label v-for="it in gotypes" class="btn btn-secondary" :class="{active: it===gotype}" @click="gotype = it">
        <input type="radio"> {{it}}
      </label>
    </div></div><br>

    <div><div class="btn-group" data-toggle="buttons">
      <label v-for="it in testdatakeys" class="btn btn-secondary" :class="{active: it===testdatakey}" @click="testdatakey = it">
        <input type="radio"> {{it}}
      </label>
    </div></div><br>

    <input id="input" autofocus style="width:300px" v-model="inputValue" :placeholder="testdatakey" />

    <div v-if="results.total !== undefined">
      <p>{{results.total}} matches in {{duration}}ms</p>
      <ul>
        <li v-for="result in results">{{result.score}} - <span v-html="result.highlighted"></span></li>
      </ul>
    </div>
  </div>
</div>

<script>
  window.app = new Vue({
    el: '#app',
    data: {
      gotypes: ['Async', 'Sync'],
      gotype: 'Async',
      testdatakeys: Object.keys(testdata),
      testdatakey: 'ue4_filenames',
      inputValue: '',
      duration: null,
      results: [],
    },
    watch: {
      // inputValue: () => { setTimeout(refresh) }, // timeout to avoid vue performance issues
      gotype: () => { setTimeout(refresh) }, // timeout to avoid vue performance issues
      testdatakey: () => { setTimeout(refresh) }, // timeout to avoid vue performance issues
    },
  })
  var promise, startms
  var $input = $('#input')

  // Select input when escape pressed
  document.onkeyup = (e) => {
    if(e.keyCode === 27) $input.select()
  }
  // Focus input when any key pressed
  document.onkeydown = (e) => {
    $input.focus()
  }
  // Refresh on input change
  $input.on('input', refresh)

  function refresh() {
    if(app.gotype === 'Async') {
      if(promise) promise.cancel()

      startms = Date.now()
      promise = fuzzysort.goAsync(app.inputValue, testdata[app.testdatakey])
      promise.then(renderResults, err=>console.log(err))
    } else {
      startms = Date.now()
      renderResults(fuzzysort.go(app.inputValue, testdata[app.testdatakey]))
    }
  }

  function renderResults(results) {
    app.duration = Date.now() - startms
    app.results = results
  }
</script>
